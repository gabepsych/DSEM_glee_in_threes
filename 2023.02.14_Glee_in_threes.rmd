---
title: "Glee in Threes - Full-analyses"
author: "Gabriel A. Leon"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r, echo=FALSE, include = FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(psych)
library(purrr)
library(gdata)
library(tidyr)
library(irr)
library(knitr)
library(lmerTest)
library(tictoc)
library(DescTools)

library(sjPlot)
library(sjmisc)
library(car)
library(stringr)
library(MplusAutomation)
library(jtools)
library(rempsyc)
library(flextable)
source("random_eff_reliabilities.r")
library(haven)

#gc(rm(list=ls()))
```

# Import the Datavyu spreadsheet data
```{r}
#Create a list of filenames taken from
#the Datavyu spreadsheets in the working directory

# "lt' refers to the original coder (Lexi T.)
files.lt <- list.files(pattern = "*lt.csv")
files.lt <- setNames(files.lt,files.lt)

# "affect" refers to the Couples 72 - 90
# that were coded by Jasmin, Haley, Leo, Sam, and Sarah
files.affect <- list.files(pattern = "*affect.csv")
files.affect <- setNames(files.affect, files.affect)

#Create of vector of the couple IDs
id <- c()
for(i in 1:length(files.lt)){
  id[i] <- substr(files.lt[[i]],10,11) #Rips the IDs from the filenames
}
id.1 <- c()
for(i in 1:length(files.affect)){
  id.1[i] <- substr(files.affect[[i]],1,2) #Rips the IDs from the filenames
}

#Read each spreadsheet as a .csv
list <- map(files.lt, .f = read.csv)
list.1 <- map(files.affect, .f = read.csv)
#Grab the column names from the first spreadsheet
realnames <- names(list[[1]])
realnames.1 <- names(list.1[[1]])

#Normalize the columns names across all spreadsheets
list <- lapply(list, setNames, realnames)
list.1 <- lapply(list.1, setNames, realnames.1)

#Remove extra blank columns that were reserved for notes
truncate_empty_columns <- function(dataframe){
    dataframe_new <- dataframe[,1:120]
    return(dataframe_new)
}
list <- lapply(list, truncate_empty_columns)

truncate_empty_columns.1 <- function(dataframe){
    dataframe_new <- dataframe[,1:(length(dataframe)-9)]
    return(dataframe_new)
}
list.1 <- lapply(list.1, truncate_empty_columns.1)

#Add an "id" column to each spreadsheet
list <- Map(cbind, list, id = id)
list.1 <- Map(cbind, list.1, id = id.1)

# This code can be used to confirm that spreadsheets are all the same size
# nameslength <- length(names(list[[1]]))
# check <- c()
# for(i in 1:length(list)){
#   check[i] <- nameslength == length(names(list[[i]]))
# }
# check
# nameslength <- length(names(list.1[[1]]))
# check <- c()
# for(i in 1:length(list.1)){
#   check[i] <- nameslength == length(names(list.1[[i]]))
# }
# check


#Bind all spreadsheets into a single dataframe
df <- do.call("rbind", list)
df.1 <- do.call("rbind", list.1)

#Reorder the columns to make the "id" column the first in the dataframe
df <- df[,c(121,1:120)]
df.1 <- df.1[,c(length(df.1),1:(length(df.1)-1))]
#Get rid of rownames
rownames(df) <- c()
rownames(df.1) <- c()

```

# Separate the spreadsheet by partner (i.e., dad, mom, infant) and behavioral dimensions (e.g., affect, gaze, etc.)
``` {r}
#Separate data by partner and behavioral dimension
separate_data <- function(df,string){
  out <- select(df,id, colnames(df)[grepl(string,colnames(df))]) 
return(out[,1:5])
  }

Dad_Affect        <- separate_data(df, "Dad_Affect")
Dad_Vocalization <- separate_data(df, "Dad_Vocal")
Dad_Touch        <- separate_data(df, "Dad_Touch")
Dad_Gaze          <- separate_data(df, "Dad_Gaze")
Dad_Bystander   <- separate_data(df, "Dad_Bystand")

Mom_Affect        <- separate_data(df, "Mom_Affect")
Mom_Vocalization <- separate_data(df, "Mom_Vocal")
Mom_Touch       <- separate_data(df, "Mom_Touch")
Mom_Gaze <- separate_data(df, "Mom_Gaze")
Mom_Bystander <- separate_data(df, "Mom_Bystand")

Infant_Affect <- separate_data(df, "Infant_Affect")
Infant_Vocalization <- separate_data(df, "Infant_Vocal")
Infant_Touch <- separate_data(df, "Infant_Touch")
Infant_Gaze <- separate_data(df, "Infant_Gaze")

Dad_Affect.1 <- separate_data(df.1, "Dad_Affect")
Mom_Affect.1 <- separate_data(df.1, "Mom_Affect")
Infant_Affect.1 <- separate_data(df.1, "Infant_Affect")
names(Dad_Affect.1) <- names(Dad_Affect)
names(Mom_Affect.1) <- names(Mom_Affect)
names(Infant_Affect.1) <- names(Infant_Affect)

Dad_Affect <- rbind(Dad_Affect, Dad_Affect.1)
Mom_Affect <- rbind(Mom_Affect, Mom_Affect.1)
Infant_Affect <- rbind(Infant_Affect, Infant_Affect.1)


#Compile data in list
list_data <- list(
  Dad_Affect, Dad_Touch, Dad_Gaze, Dad_Vocalization, Dad_Bystander,
  Mom_Affect, Mom_Touch, Mom_Gaze, Mom_Vocalization, Mom_Bystander,
  Infant_Affect, Infant_Touch, Infant_Gaze, Infant_Vocalization 
)

#Separate each sublist by id
split_id <- function(df){
  new_df <- group_split(df, id)
  return(new_df)
}

list_data2 <- list()
for (i in 1:length(list_data)){
  list_data2[[i]] <- split_id(list_data[[i]])
}
```

# Repeat the same process for the reliability dataset
```{r}
##RELIABILITY DATA##
#Separate data by partner and behavioral dimension, but now we are modifying the reliability columns
separate_data_rel <- function(df,string){
  out <- select(df,id, colnames(df)[grepl(string,colnames(df))]) 
return(out[,c(1,6:9)]) #This skips the main columns and only selects the reliability columns
  }
Dad_Affect_rel        <- separate_data_rel(df, "Dad_Affect")
Dad_Vocalization_rel <- separate_data_rel(df, "Dad_Vocal")
Dad_Touch_rel        <- separate_data_rel(df, "Dad_Touch")
Dad_Gaze_rel          <- separate_data_rel(df, "Dad_Gaze")
Dad_Bystander_rel   <- separate_data_rel(df, "Dad_Bystand")

Mom_Affect_rel        <- separate_data_rel(df, "Mom_Affect")
Mom_Vocalization_rel <- separate_data_rel(df, "Mom_Vocal")
Mom_Touch_rel       <- separate_data_rel(df, "Mom_Touch")
Mom_Gaze_rel <- separate_data_rel(df, "Mom_Gaze")
Mom_Bystander_rel <- separate_data_rel(df, "Mom_Bystand")

Infant_Affect_rel <- separate_data_rel(df, "Infant_Affect")
Infant_Vocalization_rel <- separate_data_rel(df, "Infant_Vocal")
Infant_Touch_rel <- separate_data_rel(df, "Infant_Touch")
Infant_Gaze_rel <- separate_data_rel(df, "Infant_Gaze")

#Compile data in list
list_data_rel <- list(
  Dad_Affect_rel, Dad_Touch_rel, Dad_Gaze_rel, Dad_Vocalization_rel, Dad_Bystander_rel,
  Mom_Affect_rel, Mom_Touch_rel, Mom_Gaze_rel, Mom_Vocalization_rel, Mom_Bystander_rel,
  Infant_Affect_rel, Infant_Touch_rel, Infant_Gaze_rel, Infant_Vocalization_rel 
)

#Separate each sublist by id
split_id <- function(df){
  new_df <- group_split(df, id)
  return(new_df)
}

list_data2_rel <- list()
for (i in 1:length(list_data_rel)){
  list_data2_rel[[i]] <- split_id(list_data_rel[[i]])
}
```

# Create a function to transform the data into categorical time series
```{r}
#Set the epoch for each behavior; 1 = 1sec
timing_interval <- 1

cate_ts <- function(df){
df_small <- as.data.frame(df)
df_small[,3] <- round((df_small[,3]/(timing_interval*1000)),0)
df_small[,4] <- round((df_small[,4]/(timing_interval*1000)),0)
  list1 <- list()
x <- rep(NA, times = (df_small[1,3]-df_small[1,2]))

x.1 <- rep(df_small[1,2], length(x))
list1 <- as.data.frame(cbind(x.1,x))

list2 <- list()
for (i in 1:(max(na.omit(df_small[,2]))+1)){
  y <- rep(df_small[i,5], ifelse(df_small[i,4]-df_small[i,3] <= 0,
                                 1,
                                 df_small[i,4]-df_small[i,3]))
  y.1 <- rep(df_small[i+1,2], length(y))
  q <- cbind(y.1,y)
  q[,1] <- ifelse(is.na(q[,1])==TRUE, (max(na.omit(df_small[,2]))+1), q[,1])
  list2[[i]] <-q
}
list2 <- lapply(list2, as.data.frame)
list3 <- do.call(rbind, list2)

names <- c("ordinal","code")
names(list1) <- names(list3) <- names
list4 <- rbind(list1,list3)
list4$id <- df_small[1,1]
list4$person <- stringr::str_sub(names(df_small)[2], 1, 3)
list4$dimension <- stringr::str_extract(names(df_small)[2], "_....")
list4$time <- 1:nrow(list4)
list4$time_c <- scale(list4$time, scale = FALSE)
list4 <- list4 %>% select(id, person, dimension, time,time_c, ordinal, code)  
}


#Initialize the blank lists
list_data3 <- list()
list_data4 <- list()
for (i in 1:length(list_data2)){
  list_data3[[i]] <- list()
  for (j in 1:length(list_data2[[i]])){
    list_data4[[i]] <- list()
    list_data4[[i]][[j]] <- data.frame()
  }
}

#Initialize blank lists for reliability columns
list_data3_rel <- list()
list_data4_rel <- list()
for (i in 1:length(list_data2_rel)){
  list_data3_rel[[i]] <- list()
  for (j in 1:length(list_data2_rel[[i]])){
    list_data4_rel[[i]] <- list()
    list_data4_rel[[i]][[j]] <- data.frame()
  }
}

```

# Apply the cate_ts() function to create categorical time series data
```{r, cache = TRUE}
#Main codes
for (i in 1:length(list_data4)){
  for (j in 1:length(list_data4[[i]])){
    list_data4[[i]][[j]] <- cate_ts(as.data.frame(list_data2[[i]][[j]])) 
  }
}


#Reliability codes
for (i in 1:length(list_data4_rel)){
  for (j in 1:length(list_data4_rel[[i]])){
    list_data4_rel[[i]][[j]] <- cate_ts(as.data.frame(list_data2_rel[[i]][[j]])) 
  }
}

```

# Bind all the rows in the list into a single data frame
```{r}
list_data5 <- list()
for(i in 1:length(list_data4)){
  list_data5[[i]] <- do.call(rbind, list_data4[[i]])
}


full_data_by_dimension <- list_data5
full_data <- do.call(rbind, list_data5)
full_data$person <- as.factor(full_data$person)
full_data$dimension <- as.factor(full_data$dimension)
full_data$time <- as.numeric(full_data$time)
full_data$time_c <- as.numeric(full_data$time_c)
full_data$ordinal <- as.numeric(full_data$ordinal)
full_data$code <- as.character(full_data$code)
levels(full_data$dimension) <- list(affect = "_Affe",
                                    bystand = "_Byst",
                                    gaze = "_Gaze",
                                    touch = "_Touc",
                                    vocal = "_Voca")

##Reliability
list_data5_rel <- list()
for(i in 1:length(list_data4_rel)){
  list_data5_rel[[i]] <- do.call(rbind, list_data4_rel[[i]])
}


full_data_by_dimension_rel <- list_data5_rel
full_data_rel <- do.call(rbind, list_data5_rel)
full_data_rel$person <- as.factor(full_data_rel$person)
full_data_rel$dimension <- as.factor(full_data_rel$dimension)
full_data_rel$time <- as.numeric(full_data_rel$time)
full_data_rel$time_c <- as.numeric(full_data_rel$time_c)
full_data_rel$ordinal <- as.numeric(full_data_rel$ordinal)
full_data_rel$code <- as.character(full_data_rel$code)
levels(full_data_rel$dimension) <- list(affect = "_Affe",
                                    bystand = "_Byst",
                                    gaze = "_Gaze",
                                    touch = "_Touc",
                                    vocal = "_Voca")


reliability_names <- c("id","person","dimension","time","time_c_rel","ordinal_rel","code_rel")
names(full_data_rel) <- reliability_names

full_data_all <- merge(full_data, full_data_rel, by = c("id","person","dimension","time"))
full_data_all <- full_data_all[order(
  full_data_all$id,
  full_data_all$person,
  full_data_all$dimension,
  full_data_all$time
),]

full_data_all <- full_data_all %>% select(-time_c, -time_c_rel)
write.csv(full_data, "data_6pp_Microcoded_FreePlay_CategoricalTimeSeries_1sec.csv")
```

# Separate the categorical time series by PERSON and DIMENSION
```{r}
library(plyr)
#Load the categorical time series data
data <- read.csv("data_6pp_Microcoded_FreePlay_CategoricalTimeSeries_1sec.csv")
#Select only the variables we need for the analyses
data <- data %>% dplyr::select(id,person,time,code,dimension)

# Filter to get only the "affect" behavioral data
dimensions <- c("affect","gaze","touch","vocal","bystand")
persons <- c("Dad","Mom","Inf")
data_list_by_dimension <- list()
for(i in 1:length(dimensions)){
  data_list_by_dimension[[i]] <- list()
  for(j in 1:length(persons)){
    data_list_by_dimension[[i]][[j]] <- data %>%
                                        dplyr::filter(dimension == dimensions[i]) %>%
                                        dplyr::filter(person == persons[j])
    names(data_list_by_dimension[[i]][[j]])[4] <- paste(dimensions[i],
                                                        persons[j],
                                                        sep = "_")
    data_list_by_dimension[[i]][[j]] <- data_list_by_dimension[[i]][[j]] %>%
      dplyr::select(-person,-dimension)
  }
  data_list_by_dimension[[i]] <- plyr::join_all(data_list_by_dimension[[i]],
                                                by = c("id","time"),
                                                type = "full")
}
data_categorical_timeseries <- plyr::join_all(data_list_by_dimension,
                                              by = c("id","time"),
                                              type = "full") %>% dplyr::select(-bystand_Inf)

data_CateTS_list <- split(data_categorical_timeseries,
                          data_categorical_timeseries$id)

for(i in 1:length(data_CateTS_list)){
  vector <- c()
  for(j in 1:nrow(data_CateTS_list[[i]])){
    vector[j] <- mean(is.na(data_CateTS_list[[i]][j,3:16]))
  }
  data_CateTS_list[[i]] <- data_CateTS_list[[i]] %>%
    mutate(omit_test = vector) %>%
    dplyr::filter(omit_test != 1) %>%
    dplyr::select(-omit_test) %>%
    mutate(new_time = time - min(time)) # Create a new time variable that resets each family's starting point at zero
}

# Check the length of time for each family's interaction
seconds <- c()
for(i in 1:length(data_CateTS_list)){
  seconds[i] <- nrow(data_CateTS_list[[i]])
}
seconds <- seconds
minutes <- seconds/60

seconds #Number of Seconds for each interaction
minutes #Number of Minutes for each interaction

data_categorical_timeseries <- do.call(rbind, data_CateTS_list)

# Save CSV file with all categorical time-series 

write.csv(data_categorical_timeseries,
          "data_6pp_Microcoded_FreePlay_CategoricalTimeSeries_1sec_BY_PERSON_AND_DIMENSION.csv")
```

# Compute IRR using ICC and a three-level MLM
```{r, warning=FALSE}
full_data_icc <- full_data
full_data_rel_icc <- full_data_rel

names(full_data_rel_icc) <- names(full_data)

full_data_icc$coder <- 1 #Coder #1
full_data_rel_icc$coder <- 2 # Coder #2

full_data_all_icc <- rbind(full_data_icc, full_data_rel_icc) %>%
  dplyr::filter(dimension == "affect") %>%  
  mutate(code_1 = dplyr::recode(code, #Recode affective dimensions 
         aa = "0",
         aw = "0",
         na = "0",
         an = "1",
         ap = "2",
         aph = "2",
         apl = "2",
         au = "NA"))
full_data_all_icc$code_1 <- as.numeric(full_data_all_icc$code_1)
table(full_data_all_icc$code) #Original Codes
table(full_data_all_icc$code_1) #New codes
sum(is.na(full_data_all_icc$code)) #Original Missing data
sum(is.na(full_data_all_icc$code_1)) #Missing data w/ "au" = MISSING; 12136+14099


fit1_ICC_mom <- lmer(code_1 ~ (coder|id),
                     data = full_data_all_icc %>% dplyr::filter(person == "Mom"))
fit1_ICC_dad <- lmer(code_1 ~ (coder|id),
                     data = full_data_all_icc %>% dplyr::filter(person == "Dad"))
fit1_ICC_Inf <- lmer(code_1 ~ (coder|id),
                     data = full_data_all_icc %>% dplyr::filter(person == "Inf"))

paste("mom","ICC =", summ(fit1_ICC_mom, digits = 5)$gvars[3])
paste("dad","ICC =", summ(fit1_ICC_dad, digits = 5)$gvars[3])
paste("infant","ICC =", summ(fit1_ICC_Inf, digits = 5)$gvars[3])
```
# Compute Cohen's K across all dimensions
```{r, cache = TRUE, warning=FALSE}
full_data_all_k <- mutate(full_data_all,
                        person_dimension = paste(as.character(person),"_", as.character(dimension), sep = ""))
full_data_all_k$person_dimension <- as.factor(full_data_all_k$person_dimension)

full_data_all_k <- full_data_all_k %>%
  mutate(code_1 = dplyr::recode(code,
         aa = "0",
         aw = "0",
         na = "0",
         an = "1",
         ap = "2",
         aph = "2",
         apl = "2",
         au = "NA"),
         
         code_rel_1 = dplyr::recode(code_rel,
         aa = "0",
         aw = "0",
         na = "0",
         an = "1",
         ap = "2",
         aph = "2",
         apl = "2",
         au = "NA"))
table(dplyr::filter(full_data_all_k,
                    dimension== "affect")$code_1)
table(dplyr::filter(full_data_all_k,
                    dimension== "affect")$code_rel_1)

kappas <- array(dim = c(14,7,53))

kappas <- list()
for(i in 1:length(unique(full_data_all_k$id))){
  kappas[[i]] <- matrix(NA, nrow = length(unique(full_data_all_k$person_dimension)), ncol = 7)
}

for(i in 1:length(unique(full_data_all_k$id))){
  for(j in 1:length(unique(full_data_all_k$person_dimension))){
    kappas[[i]][j,1] <- unique(full_data_all_k$id)[i]
    kappas[[i]][j,2] <- as.character(unique(full_data_all_k$person_dimension)[j])
    subset <- full_data_all_k %>% filter(
      id == unique(full_data_all_k$id)[i] &
      person_dimension == unique(full_data_all_k$person_dimension)[j])
    subset <- subset %>% select(code_1, code_rel_1)
    k <- kappa2(subset)
    kappas[[i]][j,3] <- k[[2]]
    kappas[[i]][j,4] <- k[[5]]
    kappas[[i]][j,5] <- k[[7]]
    kappas[[i]][j,6] <- k[[8]]
    subset.noNA <- na.omit(subset)
    kappas[[i]][j,7] <- mean(subset.noNA[,1]==subset.noNA[,2])
  }
}
kappas <- do.call("rbind", kappas)
kappas <- as.data.frame(kappas)
names(kappas) <- c("id","person_dimension","time_points","cohen_k","z","p","percent_agree")
kappas$id <- as.factor(kappas$id)
kappas$person_dimension <- as.factor(kappas$person_dimension)
kappas$time_points <- as.numeric(kappas$time_points)
kappas$cohen_k <- as.numeric(kappas$cohen_k)
kappas$z <- as.numeric(kappas$z)
kappas$p <- as.numeric(kappas$p)
kappas$percent_agree <- as.numeric(kappas$percent_agree)

 k<- kappas
kable1 <- kable(k %>%
  dplyr::group_by(person_dimension) %>%
    dplyr::filter(cohen_k > 0) %>%
  dplyr::summarize(mean_cohen_k = mean(cohen_k, na.rm = TRUE),
            mean_z = mean(z,na.rm = TRUE),
            mean_p = mean(p,na.rm = TRUE),
            mean_perc_agree = mean(percent_agree, na.rm = TRUE)))
kable1

arrange(dplyr::filter(k %>% select(id, person_dimension, cohen_k), person_dimension == "Dad_affect"), cohen_k) #Dad's Affect
arrange(dplyr::filter(k %>% select(id, person_dimension, cohen_k), person_dimension == "Mom_affect"), cohen_k) #Mom's Affect
arrange(dplyr::filter(k %>% select(id, person_dimension, cohen_k), person_dimension == "Inf_affect"), cohen_k) #Infant's Affect
```

# Try to improve reliability
```{r}
discordant <- full_data_all_k %>% dplyr::filter(code_1 != code_rel_1) %>%
  dplyr::filter(person_dimension == "Dad_affect"|
                      person_dimension == "Mom_affect" |
                      person_dimension == "Inf_affect")

table(discordant$code_1, discordant$code_rel_1, dnn = c("code","rel"))

# Identify the families who have Kappa < .3
low_kappas <- 
rbind(
 arrange(dplyr::filter(
  k %>% select(id, person_dimension, cohen_k) %>% dplyr::filter(cohen_k < .3),
  person_dimension == "Dad_affect"), id), #Dad's Affect

arrange(dplyr::filter(
  k %>% select(id, person_dimension, cohen_k) %>% dplyr::filter(cohen_k < .3),
  person_dimension == "Mom_affect"), id), #Mom's Affect

arrange(dplyr::filter(
  k %>% select(id, person_dimension, cohen_k) %>% dplyr::filter(cohen_k < .3),
  person_dimension == "Inf_affect"), id) #Infant's Affect
)
low_kappas
length(unique(low_kappas$id))
unique(low_kappas$id)

```

# Create a boxplot to compare average Cohen K across behavioral dimensions
```{r}
boxplot1 <- ggplot(data = k %>%
    dplyr::filter(cohen_k > 0), aes(x=factor(person_dimension), y = cohen_k)) +
  geom_boxplot(notch = TRUE) +
  stat_summary(fun = "mean", geom="point", shape = 1, size = 2, fill= "white") +
  labs(x = "Person_Dimension", y = "Cohen Kappa") + 
  geom_hline(yintercept = mean(k$cohen_k, na.rm = TRUE), color = "red")
boxplot1

boxplot2 <- ggplot(data = k %>%
    dplyr::filter(cohen_k > 0) %>%
      dplyr::filter(person_dimension == "Mom_affect"|
                      person_dimension == "Dad_affect"|
                      person_dimension == "Inf_affect"), aes(x=factor(person_dimension), y = cohen_k)) +
  geom_boxplot(notch = TRUE) +
  stat_summary(fun = "mean", geom="point", shape = 1, size = 2, fill= "white") +
  labs(x = "Affect by Person", y = "Cohen Kappa") + 
   scale_x_discrete(labels = c('Dad','Infant','Mom')) +
  geom_hline(yintercept = mean(k$cohen_k, na.rm = TRUE), color = "red")
boxplot2
```

# Create spaghetti plots to evaluate drift in inter-rater reliability over time
```{r, cache = TRUE,warning=FALSE}
k2 <- k
k2$id <- as.numeric(k2$id)

dad <- dplyr::filter(k2,
                      person_dimension == "Dad_affect" |
                      person_dimension == "Dad_bystand" |
                      person_dimension == "Dad_gaze" |
                      person_dimension == "Dad_touch" |
                      person_dimension == "Dad_vocal" )
mom <- dplyr::filter(k2,
                       person_dimension == "Mom_affect" |
                       person_dimension == "Mom_bystand" |
                       person_dimension == "Mom_gaze" |
                       person_dimension == "Mom_touch" |
                       person_dimension == "Mom_vocal" )
infant <- dplyr::filter(k2,
                       person_dimension == "Inf_affect" |
                       person_dimension == "Inf_gaze" |
                       person_dimension == "Inf_touch" |
                       person_dimension == "Inf_vocal" )

library(RColorBrewer)

ggplot(data = dad, aes(x = id, y = cohen_k, group = person_dimension, color=factor(person_dimension))) +
  geom_point() + 
  geom_line(data=dad) +
  xlab("ID") + 
  ylab("Cohen's K") +
  geom_smooth() +
  scale_color_brewer(palette = "Set1")

ggplot(data = mom, aes(x = id, y = cohen_k, group = person_dimension, color=factor(person_dimension))) +
  geom_point() + 
  geom_line(data=mom) +
  xlab("ID") + 
  ylab("Cohen's K") +
  geom_smooth() +
  scale_color_brewer(palette = "Dark2")

ggplot(data = infant, aes(x = id, y = cohen_k, group = person_dimension, color=factor(person_dimension))) +
  geom_point() + 
  geom_line(data=infant) +
  xlab("ID") + 
  ylab("Cohen's K") +
  geom_smooth() +
  scale_color_brewer(palette = "Set3")
```

# Data Analysis - Pre-Processing

## Load Data
```{r}
gc(rm(list=ls()))

data <- read.csv("data_6pp_Microcoded_FreePlay_CategoricalTimeSeries_1sec_BY_PERSON_AND_DIMENSION.csv", na.strings = "NA")[,-1]
sensitivity <- read.csv("qualitative data final_clean.csv")
names(sensitivity) <- c("id","qual_mom","qual_dad")
baseline <- read_excel("HATCH 6.4.2021 with time with baby.xlsx")
```

## Compute the proportation of affect data that are missing
```{r}
data <- data %>% select(id, new_time, affect_Mom, affect_Dad, affect_Inf)
data <- data[rowSums(is.na(data)) < 3,]

data_list <- split(data, data$id)
# Compute the proportion of affect codes that are missing
prop_missing <- matrix(NA, nrow = length(unique(data$id)), ncol = 4)
for(i in 1:length(unique(data$id))){
  df <- data_list[[i]]
  id <- unique(df$id)
  dad <- sum(df$affect_Dad =="au", na.rm = TRUE)/length(df$affect_Dad)
  mom <- sum(df$affect_Mom =="au", na.rm = TRUE)/length(df$affect_Mom)
  infant <- sum(df$affect_Inf =="au", na.rm = TRUE)/length(df$affect_Inf)
  fam <- c(id,dad,mom,infant)
  prop_missing[i,] <- fam
}
prop_missing <- data.frame(prop_missing)
names(prop_missing) <- c("id", "dad", "mom","infant")
prop_missing <- round(prop_missing, digits = 2)
prop_missing

# min_miss <- .20
# prop_missing %>% dplyr::filter(dad > min_miss)
# prop_missing %>% dplyr::filter(mom > min_miss)
# prop_missing %>% dplyr::filter(infant > min_miss)

paste("Dad prop. missing =",mean(prop_missing$dad))
paste("Mom prop. missing =",mean(prop_missing$mom))
paste("Infant prop. missing =",mean(prop_missing$infant))

#data_list <- data_list[prop_missing$dad <.70  & prop_missing$mom < .70 & prop_missing$infant < .70]
```
## Select the baseline measures for final analysis
```{r}
# Grab the baseline measures of interest

baseline_s <- baseline %>% select(CoupID, Education.1, Education.2, Age_1.1, Age_1.2, #Parental age and education
                                  bage6pp, Baby.sex, ZBirthweightgr2, ZGestationalAgeWeeks, # Infant Age, Sex, Birth Weight, and Gestational Age
                                  PSI.tot.1, PSI.tot.2, #Parenting stress index
                                  momhairPPconverted.trunc, #Mom Hair cortisol
                                  dadhairPPconverted.trunc, #Dad Hair cortisol
                                  infhairPPconverted.trunc, #Infant hair cortisol

                                  )


baseline_s$PSI.tot.1 <- scale(baseline_s$PSI.tot.1, center = TRUE, scale =TRUE)[,1]
baseline_s$PSI.tot.2 <- scale(baseline_s$PSI.tot.2, center = TRUE, scale =TRUE)[,1]

baseline_s <- baseline_s %>% dplyr::mutate_all(~ifelse(is.nan(.), NA, .))
colnames(baseline_s)[1] <- "id"

#baseline_final <- inner_join(baseline_s, id_data, "id")

data <- left_join(data, sensitivity, "id")
data <- left_join(data, baseline_s, "id")


```

## Convert codes to categorical time-series data
```{r, warning=FALSE}
convert_affect <- function(data1){
  data <- data1
  
  ##Dad
  data$affect_Dad_binary <- data$affect_Dad
  data$affect_Dad_binary <- ifelse(data$affect_Dad=="aw"|data$affect_Dad=="aa", 0,
                                   data$affect_Dad_binary)
  data$affect_Dad_binary <- ifelse(data$affect_Dad=="aph", 1,
                                   data$affect_Dad_binary)
  data$affect_Dad_binary <- ifelse(data$affect_Dad=="apl", 1,
                                   data$affect_Dad_binary)
  data$affect_Dad_binary <- ifelse(data$affect_Dad=="an", 0,
                                   data$affect_Dad_binary)
  data$affect_Dad_binary <- ifelse(data$affect_Dad=="au", NA,
                                   data$affect_Dad_binary)
  
  ##Mom
  data$affect_Mom_binary <- data$affect_Mom
  data$affect_Mom_binary <- ifelse(data$affect_Mom=="aw"|data$affect_Mom=="aa", 0,
                                   data$affect_Mom_binary)
  data$affect_Mom_binary <- ifelse(data$affect_Mom=="apl", 1,
                                   data$affect_Mom_binary)
  data$affect_Mom_binary <- ifelse(data$affect_Mom=="aph", 1,
                                   data$affect_Mom_binary)
  data$affect_Mom_binary <- ifelse(data$affect_Mom=="an", 0,
                                   data$affect_Mom_binary)
  data$affect_Mom_binary <- ifelse(data$affect_Mom=="au", NA,
                                   data$affect_Mom_binary)
  
  ##Infant
  data$affect_Inf_binary_pos <- data$affect_Inf
  data$affect_Inf_binary_pos <- ifelse(data$affect_Inf_binary_pos=="aa", "neg",
                                       data$affect_Inf_binary_pos)
  data$affect_Inf_binary_pos <- ifelse(data$affect_Inf_binary_pos=="an", "neu",
                                       data$affect_Inf_binary_pos)
  data$affect_Inf_binary_pos <- ifelse(data$affect_Inf_binary_pos=="au", "un",
                                       data$affect_Inf_binary_pos)
  data$affect_Inf_binary_pos <- ifelse(data$affect_Inf_binary_pos=="ap", "pos",
                                       data$affect_Inf_binary_pos)
  data$affect_Inf_binary_pos <- ifelse(data$affect_Inf_binary_pos=="pos",1,0)
  
  data$affect_Inf_binary_neg <- data$affect_Inf
  data$affect_Inf_binary_neg <- ifelse(data$affect_Inf_binary_neg=="aa", "neg",
                                       data$affect_Inf_binary_neg)
  data$affect_Inf_binary_neg <- ifelse(data$affect_Inf_binary_neg=="an", "neu",
                                       data$affect_Inf_binary_neg)
  data$affect_Inf_binary_neg <- ifelse(data$affect_Inf_binary_neg=="au", "un",
                                       data$affect_Inf_binary_neg)
  data$affect_Inf_binary_neg <- ifelse(data$affect_Inf_binary_neg=="ap", "pos",
                                       data$affect_Inf_binary_neg)
  data$affect_Inf_binary_neg <- ifelse(data$affect_Inf_binary_neg=="neg",1,0)
  
  data$affect_Inf_binary_neg <- as.factor(data$affect_Inf_binary_neg)
  data$affect_Inf_binary_pos <- as.factor(data$affect_Inf_binary_pos)

  data$affect_Mom_binary <- as.numeric(data$affect_Mom_binary)
  data$affect_Dad_binary <- as.numeric(data$affect_Dad_binary)
  
  data$affect_Inf_ord <- data$affect_Inf
  data$affect_Inf_ord <- ifelse(data$affect_Inf_ord == "aa",
                                "0",
                                data$affect_Inf_ord)
  data$affect_Inf_ord <- ifelse(data$affect_Inf_ord == "an",
                                "1",
                                data$affect_Inf_ord)
  data$affect_Inf_ord <- ifelse(data$affect_Inf_ord == "ap",
                                "2",
                                data$affect_Inf_ord)
  data$affect_Inf_ord <- ifelse(data$affect_Inf_ord == "au",
                                NA,
                                data$affect_Inf_ord)
  data$affect_Inf_ord <- as.numeric(data$affect_Inf_ord)
  
  data$affect_MomDad_Joint <-ifelse(data$affect_Dad_binary == 1 & data$affect_Mom_binary == 1, 1, 0)
  data$affect_MomInf_Joint <-ifelse(data$affect_Inf_binary_pos == 1 & data$affect_Mom_binary == 1, 1, 0)
  data$affect_DadInf_Joint <-ifelse(data$affect_Inf_binary_pos == 1 & data$affect_Dad_binary == 1, 1, 0)
  
  data <-
    data %>% 
    group_by(id) %>% 
    mutate(affect_Mom_binary_c = mean(affect_Mom_binary, na.rm = TRUE),
           affect_Dad_binary_c = mean(affect_Dad_binary, na.rm = TRUE),
           affect_Dad_binary_w = (affect_Dad_binary - mean(affect_Dad_binary, na.rm = TRUE)),
           affect_Mom_binary_w = (affect_Mom_binary - mean(affect_Mom_binary, na.rm = TRUE))) %>% 
    ungroup()
  
  return(data)
}

data <- convert_affect(data)
```

## Prepare data for Mplus
```{r, warning=FALSE}
#Rename variables as needed
#dput(names(data))

data_for_mplus <- data %>% select(id,
                                  new_time,
                                  bage6pp,
                                  Baby.sex,
                                  ZBirthweightgr2,
                                  ZGestationalAgeWeeks, 
                                  affect_Mom_binary,
                                  affect_Dad_binary,
                                  affect_Inf_ord,
                                  momhairPPconverted.trunc, #Mom Hair cortisol
                                  dadhairPPconverted.trunc, #Dad Hair cortisol
                                  infhairPPconverted.trunc, #Infant hair cortisol
                                  PSI.tot.1, PSI.tot.2 #Parenting stress index
                                  )

# data_for_mplus <- data_for_mplus %>%        
#   group_by(id) %>%
#   dplyr::mutate(mom_lag1 = dplyr::lag(affect_Mom_binary, n = 1, default = NA),
#                 dad_lag1 = dplyr::lag(affect_Dad_binary, n = 1, default = NA),
#                 inf_lag1 = dplyr::lag(affect_Inf_ord, n = 1, default = NA)) %>% 
#   as.data.frame()

newNames <- c("id",
              "time", "age_i", "sex_i", "b_weight","z_gest",
              "aff_m","aff_d","aff_i",
              "HCC.m", "HCC.d", "HCC.inf",
              "PSI.m","PSI.d")
names(data_for_mplus) <- newNames

prepareMplusData(data_for_mplus,
                 filename = "TriadicAffect.dat",
                 inpfile = TRUE)

```


# Preliminary Analyses

## Demographics

### Qualtrics questionnaire data
```{r}
data_demo <- read.csv("data_6pp_Microcoded_FreePlay_CategoricalTimeSeries_1sec_BY_PERSON_AND_DIMENSION.csv", na.strings = "NA")[,-1]
baseline_qualtrics <- read.csv("6pp.raw.csv")

baseline_qualtrics_included <- baseline_qualtrics[baseline_qualtrics$CoupleID %in% unique(data_demo$id),]  
baseline_qualtrics_included_mom <- baseline_qualtrics_included %>% dplyr::filter(Parent == "mom")
baseline_qualtrics_included_dad <- baseline_qualtrics_included %>% dplyr::filter(Parent == "dad")

baseline_qualtrics_excluded <- baseline_qualtrics[!(baseline_qualtrics$CoupleID %in% unique(data_demo$id)),]  
baseline_qualtrics_excluded_mom <- baseline_qualtrics_excluded %>% dplyr::filter(Parent == "mom")
baseline_qualtrics_excluded_dad <- baseline_qualtrics_excluded %>% dplyr::filter(Parent == "dad")
```

### Hormone data
```{r}
baseline_hormone <- read_excel("HATCH 6.4.2021 with time with baby.xlsx")

baseline_hormone_included <- baseline_hormone[baseline_hormone$CoupID %in% unique(data_demo$id),] %>%
  select(momhairPPconverted.trunc, dadhairPPconverted.trunc, infhairPPconverted.trunc,haircommentspp,hairnotes)

baseline_hormone_excluded <- baseline_hormone[!(baseline_hormone$CoupID %in% unique(data_demo$id)),] %>%
  select(momhairPPconverted.trunc, dadhairPPconverted.trunc, infhairPPconverted.trunc,haircommentspp) 

```

### Demographics
```{r}
baseline_demo <- baseline %>% select(CoupID,Education.1, Education.2, Ethnicity.1, Ethnicity.2, hincom.1, hincom.2) %>%
  mutate(Ethnicity.1.Minority = ifelse(Ethnicity.1 == 1, 0, 1),
         Ethnicity.2.Minority = ifelse(Ethnicity.1 == 1, 0, 1))

baseline_demo_included <- baseline_demo[baseline_hormone$CoupID %in% unique(data_demo$id),]
baseline_demo_excluded <- baseline_demo[!(baseline_hormone$CoupID %in% unique(data_demo$id)),]
```

## Compute differences between Mom and Dad
```{r}
t.test(
  baseline_qualtrics_included_mom %>% select(PSI_1.6pp:PSI_33.6pp) %>% rowMeans(),
  baseline_qualtrics_included_dad %>% select(PSI_1.6pp:PSI_33.6pp) %>% rowMeans(),
  paired = TRUE
) # No differences between Mom and Dad PSI-SF

t.test(
  baseline_hormone_included$dadhairPPconverted.trunc,
  baseline_hormone_included$momhairPPconverted.trunc,
  paired = TRUE
) # No difference between Mom and Dad HCC
```

## Compute differences between included and excluded samples

### PSI-SF
```{r}
wilcox.test(
  baseline_qualtrics_included_mom %>% select(PSI_1.6pp:PSI_33.6pp) %>% rowMeans(),
  baseline_qualtrics_excluded_mom %>% select(PSI_1.6pp:PSI_33.6pp) %>% rowMeans()
)
#No differences between Mom's PSI-SF

wilcox.test(
  baseline_qualtrics_included_dad %>% select(PSI_1.6pp:PSI_33.6pp) %>% rowMeans(),
  baseline_qualtrics_excluded_dad %>% select(PSI_1.6pp:PSI_33.6pp) %>% rowMeans()
)
#No differences between Dad's PSI-SF
```

### HCC
```{r}
# Dad's non-scalp HCC
paste(
mean(baseline_hormone_included$dadhairPPconverted.trunc, na.rm = TRUE) + .5*sd(baseline_hormone_included$dadhairPPconverted.trunc, na.rm = TRUE),
mean(baseline_hormone_included$dadhairPPconverted.trunc, na.rm = TRUE) - .5*sd(baseline_hormone_included$dadhairPPconverted.trunc, na.rm = TRUE)
) #  Non-scalp HCC's are within .5 SDs


# HCC differences between included and excluded 

#Mom
wilcox.test(
  as.matrix(baseline_hormone_included %>% select(momhairPPconverted.trunc)),
  as.matrix(baseline_hormone_excluded %>% select(momhairPPconverted.trunc))
) # No differences in Mom's HCC

#Dad
wilcox.test(
  as.matrix(baseline_hormone_included %>% select(dadhairPPconverted.trunc)),
  as.matrix(baseline_hormone_excluded %>% select(dadhairPPconverted.trunc))
) # No differences in Dad's HCC

#Infant 
wilcox.test(
  as.matrix(baseline_hormone_included %>% select(infhairPPconverted.trunc)),
  as.matrix(baseline_hormone_excluded %>% select(infhairPPconverted.trunc))
) # No differences in Infant's HCC
```

### Parents' ethnicity, education, and income
```{r}
#Mom Education
wilcox.test(
  as.matrix(baseline_demo_included %>% select(Education.1)),
  as.matrix(baseline_demo_excluded %>% select(Education.1))
) # No differences in Mom's education


#Dad Education
wilcox.test(
  as.matrix(baseline_demo_included %>% select(Education.2)),
  as.matrix(baseline_demo_excluded %>% select(Education.2))
) # No differences in Dad's education


#Mom Ethnicity
wilcox.test(
  as.matrix(baseline_demo_included %>% select(Ethnicity.1.Minority)),
  as.matrix(baseline_demo_excluded %>% select(Ethnicity.1.Minority))
) # No differences in Mom's ethnicity (minority vs. non-minority)


#Dad Ethnicity
wilcox.test(
  as.matrix(baseline_demo_included %>% select(Ethnicity.2.Minority)),
  as.matrix(baseline_demo_excluded %>% select(Ethnicity.2.Minority))
) # No differences in Dad's ethnicity (minority vs. non-minority)

#Mom reported household income
wilcox.test(
  as.matrix(baseline_demo_included %>% select(hincom.1)),
  as.matrix(baseline_demo_excluded %>% select(hincom.1))
) # No differences in Mom's income


#Dad reported household income
wilcox.test(
  as.matrix(baseline_demo_included %>% select(hincom.2)),
  as.matrix(baseline_demo_excluded %>% select(hincom.2))
) # No differences in Dad's income
```

## Compute Cronbach's alpha for PSI-SF
```{r}
#Mom
mom_alpha <- psych::alpha(as.matrix(baseline_qualtrics_included_mom %>% select(PSI_1.6pp:PSI_33.6pp)))
mom_alpha[[1]]

#Dad
dad_alpha <- psych::alpha(as.matrix(baseline_qualtrics_included_dad %>% select(PSI_1.6pp:PSI_33.6pp)))
dad_alpha[[1]]
```

## Infant Age
```{r}
#Infant age
mean(unique(data$bage6pp))
sd(unique(data$bage6pp))
```

## Average Affect
```{r}
avg_emot <- data %>% select(id, affect_Mom, affect_Dad, affect_Inf)
avg_emot$affect_Mom <- ifelse(avg_emot$affect_Mom=="au", NA,
                         avg_emot$affect_Mom)
avg_emot$affect_Dad <- ifelse(avg_emot$affect_Dad=="au", NA,
                         avg_emot$affect_Dad)
avg_emot$affect_Dad <- ifelse(avg_emot$affect_Dad=="na", NA,
                         avg_emot$affect_Dad)
avg_emot$affect_Mom <- ifelse(avg_emot$affect_Mom=="aw", "aa",
                         avg_emot$affect_Mom)
avg_emot$affect_Dad <- ifelse(avg_emot$affect_Dad=="aw", "aa",
                         avg_emot$affect_Dad)
avg_emot$affect_Inf <- ifelse(avg_emot$affect_Inf=="au", NA,
                         avg_emot$affect_Inf)
avg_emot$affect_Mom <- ifelse(avg_emot$affect_Mom=="aph", "apl",
                         avg_emot$affect_Mom)
avg_emot$affect_Dad <- ifelse(avg_emot$affect_Dad=="aph", "apl",
                         avg_emot$affect_Dad)

list_data <- split(avg_emot, avg_emot$id)

desc <- matrix(data = NA, ncol = 13, nrow = length(list_data))
for(i in 1:length(list_data)){
  desc[i,1] <- list_data[[i]][1,1][[1]]
  desc[i,2] <- mean(is.na(list_data[[i]][,2][[1]]), na.rm = TRUE) #Proportion Missing
  desc[i,3] <- mean(is.na(list_data[[i]][,3][[1]]), na.rm = TRUE)
  desc[i,4] <- mean(is.na(list_data[[i]][,4][[1]]), na.rm = TRUE)
  
  desc[i,5] <- mean(list_data[[i]][,2][[1]]=="aa", na.rm = TRUE) #Proportion Negative
  desc[i,6] <- mean(list_data[[i]][,3][[1]]=="aa", na.rm = TRUE)
  desc[i,7] <- mean(list_data[[i]][,4][[1]]=="aa", na.rm = TRUE)
  
  desc[i,8] <- mean(list_data[[i]][,2][[1]]=="an", na.rm = TRUE) #Proportion Neutral
  desc[i,9] <- mean(list_data[[i]][,3][[1]]=="an", na.rm = TRUE)
  desc[i,10] <- mean(list_data[[i]][,4][[1]]=="an", na.rm = TRUE)
  
  desc[i,11] <- mean(list_data[[i]][,2][[1]]=="apl", na.rm = TRUE) #Proportion Positive
  desc[i,12] <- mean(list_data[[i]][,3][[1]]=="apl", na.rm = TRUE)
  desc[i,13] <- mean(list_data[[i]][,4][[1]]=="ap",  na.rm = TRUE)
}
desc <- as.data.frame(desc)
names(desc) <- c("id",
                 "aff.M.NA", "aff.D.NA", "aff.I.NA",
                 "aff.M.AA", "aff.D.AA", "aff.I.AA",
                 "aff.M.AN", "aff.D.AN", "aff.I.AN",
                 "aff.M.AP", "aff.D.AP", "aff.I.AP")

desc_joined <- left_join(desc, sensitivity, "id")
desc_joined <- left_join(desc_joined, baseline_s, "id")


mean(desc$aff.M.AA==0)
mean(desc$aff.D.AA==0)
mean(desc$aff.I.AA<.03)

t.test(desc$aff.M.AP, desc$aff.D.AP, paired = TRUE)
mean(desc$aff.M.AP)
mean(desc$aff.D.AP)
```

# Plots

## Create time-series plots
```{r}
id_ggplot = unique(data_for_mplus$id)
index = 6 

Mom <- ggplot(
  dplyr::filter(data_for_mplus, id == id_ggplot[index]), aes(x = time/60, y = aff_m)) +
  geom_point(alpha = 0) +
  # add lines to connect the data for each person
  geom_line(aes(group = id), alpha = 2, col = "orange") + 
  scale_x_continuous("Time (minutes)") +
  scale_y_continuous("Mom Positive Affect", breaks=c(0,1),
                   labels = c("Neg/Neu", "Positive")) + theme_bw()
Dad <- ggplot(
  dplyr::filter(data_for_mplus, id == id_ggplot[index]), aes(x = time/60, y = aff_d)) +
  geom_point(alpha = 0) +
  # add lines to connect the data for each person
  geom_line(aes(group = id), alpha = 2, col = "purple") + 
  scale_x_continuous("Time (minutes)") +
  scale_y_continuous("Dad Positive Affect", breaks=c(0,1),
                     labels = c("Neg/Neu", "Positive"))+ theme_bw()

Infant <- ggplot(
  dplyr::filter(data_for_mplus, id == id_ggplot[index]), aes(x = time/60, y = aff_i)) +
  geom_point(alpha = 0) +
  # add lines to connect the data for each person
  geom_line(aes(group = id), alpha = 2, col = "green") + 
  scale_x_continuous("Time (minutes)") +
  scale_y_continuous("Infant Positive Affect", breaks=c(0,1,2),
                     labels = c("Neg","Neu", "Positive"))+ theme_bw()
ggarrange(Mom, Dad, Infant, nrow = 3, ncol =1)
```

## Correlation matrices 

```{r}
library(correlation)
library(see) # for plotting
library(ggraph) # needs to be loaded


corrp <- desc_joined %>% select(momhairPPconverted.trunc, dadhairPPconverted.trunc, infhairPPconverted.trunc,
                                PSI.tot.1, PSI.tot.2, aff.M.AP, aff.D.AP, aff.I.AP)
names(corrp)<- c("MomHCC","DadHCC","InfHCC",
                 "MomPSI","DadPSI", "AvgPA.Mom", "AvgPA.Dad", "AvgPA.Infant")

plot(correlation(corrp, partial = TRUE)) +
  scale_edge_color_continuous(low = "#000004FF", high = "#FCFDBFFF")

plot(correlation(corrp, partial = FALSE)) +
  scale_edge_color_continuous(low = "#000004FF", high = "#FCFDBFFF")

corr.results <- correlation(corrp)

corr.results %>%
  summary(redundant = FALSE) %>%
  plot(main = "Zero-Order Correlation Matrix")

corr.results.partial <- correlation(corrp, partial = TRUE)

corr.results.partial %>%
  summary(redundant = FALSE) %>%
  plot()

ggplot(desc, aes(x=aff.I.AP)) + 
  geom_histogram(color="black", fill="gray80") +
 # theme_apa() +
  xlab("Infant Positive Affect") +
  ylab("Frequency")


pairs.panels(desc[,2:4],
             smooth = TRUE,      # If TRUE, draws loess smooths
             scale = FALSE,      # If TRUE, scales the correlation text font
             density = TRUE,     # If TRUE, adds density plots and histograms
             ellipses = TRUE,    # If TRUE, draws ellipses
             method = "pearson", # Correlation method (also "spearman" or "kendall")
             pch = 21,           # pch symbol
             lm = FALSE,         # If TRUE, plots linear fit rather than the LOESS (smoothed) fit
             cor = TRUE,         # If TRUE, reports correlations
             jiggle = FALSE,     # If TRUE, data points are jittered
             factor = 2,         # Jittering factor
             hist.col = 4,       # Histograms color
             stars = TRUE,       # If TRUE, adds significance level with stars
             ci = TRUE)

df.corrp <- describe(corrp)
df.corrp <- df.corrp %>% select(n, mean, sd)
df.corrp <- round(df.corrp, digits = 2)

```

# Modeling Fitting 

## Model 1 - Baseline model with no covariates
```{r}
library(MplusAutomation)
source("random_eff_reliabilities.r")
# runModels(
#   paste(getwd(),"DSEM","DSEM_Models_1.1-1.3",sep = "/"),
#   recursive=TRUE,
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)

# runModels(
#   paste(getwd(),"DSEM","DSEM_Models_1.1-1.3",
#         "DSEM_Triadic_FreePlay_6pp_model1.1_MomAffect.inp", sep = "/"),
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)
# 
# runModels(
#   paste(getwd(),"DSEM","DSEM_Models_1.1-1.3",
#         "DSEM_Triadic_FreePlay_6pp_model1.2_DadAffect.inp", sep = "/"),
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)
# 
# runModels(
#   paste(getwd(),"DSEM","DSEM_Models_1.1-1.3",
#         "DSEM_Triadic_FreePlay_6pp_model1.3_InfantAffect.inp", sep = "/"),
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)

models_all_list_Model1 <- readModels(paste(getwd(),"DSEM","DSEM_Models_1.1-1.3",sep = "/"),
                          what = "parameters",
                          recursive = TRUE)

models_all_stdyx_Model1 <- list()
for(i in 1:length(models_all_list_Model1)){
  models_all_stdyx_Model1[[i]] <- models_all_list_Model1[[i]]$parameters$stdyx.standardized
}
sapply(models_all_stdyx_Model1, ncol)
for(i in 1:length(models_all_stdyx_Model1)){
  models_all_stdyx_Model1[[i]] <- models_all_stdyx_Model1[[i]] %>% dplyr::filter(sig == TRUE)
}
models_all_stdyx_Model1 <- do.call("rbind", models_all_stdyx_Model1)

models_all_tech4_Model1 <- readModels(paste(getwd(),"DSEM","DSEM_Models_1.1-1.3",sep = "/"),
                          what = "tech4",
                          recursive = TRUE)

rand.reliab.Model1 <- random_eff_reliabilities(models_all_tech4_Model1)
rand.reliab.Model1 <- do.call("rbind", rand.reliab.Model1)

models_all_unstand_Model1 <- list()
for(i in 1:length(models_all_list_Model1)){
  models_all_unstand_Model1[[i]] <- models_all_list_Model1[[i]]$parameters$unstandardized
}
for(i in 1:length(models_all_unstand_Model1)){
  models_all_unstand_Model1[[i]] <- models_all_unstand_Model1[[i]] %>% dplyr::filter(sig == TRUE)
}
models_all_unstand_Model1 <- do.call("rbind", models_all_unstand_Model1)

```


## Model 2 - Hair Cortisol Concentration (single moderator)

```{r}
library(MplusAutomation)

# runModels(
#   paste(getwd(),"DSEM","DSEM_Model2_HCC",
#         "2023.02.13_TriadicAffect_Model2.1_HCC_Mom.inp", sep = "/"),
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)
# 
# runModels(
#   paste(getwd(),"DSEM","DSEM_Model2_HCC",
#         "2023.02.13_TriadicAffect_Model2.2_HCC_Dad.inp", sep = "/"),
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)
# 
# runModels(
#   paste(getwd(),"DSEM","DSEM_Model2_HCC",
#         "2023.02.13_TriadicAffect_Model2.3_HCC_Infant.inp", sep = "/"),
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)

# runModels(
#   paste(getwd(),"DSEM","DSEM_Models_2.1-2.9", sep = "/"),
#   showOutput=TRUE, recursive = TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)

models_all_list_Model2 <- readModels(paste(getwd(),"DSEM","DSEM_Models_2.1-2.9",sep = "/"),
                          what = "parameters",
                          recursive = TRUE)

models_all_stdyx_Model2 <- list()
for(i in 1:length(models_all_list_Model2)){
  models_all_stdyx_Model2[[i]] <- models_all_list_Model2[[i]]$parameters$stdyx.standardized
}
sapply(models_all_stdyx_Model2, ncol)
for(i in 1:length(models_all_stdyx_Model2)){
  models_all_stdyx_Model2[[i]] <- models_all_stdyx_Model2[[i]] %>% dplyr::filter(sig == TRUE)
}
models_all_stdyx_Model2 <- do.call("rbind", models_all_stdyx_Model2)
models_all_stdyx_Model2 <- models_all_stdyx_Model2 %>% dplyr::filter(param == "HM"|
                                                         param == "HD"|
                                                         param == "HI"|
                                                         param == "PM"|
                                                         param == "PD")

models_all_tech4_Model2 <- readModels(paste(getwd(),"DSEM","DSEM_Models_2.1-2.9",sep = "/"),
                          what = "tech4",
                          recursive = TRUE)

rand.reliab.Model2 <- random_eff_reliabilities(models_all_tech4_Model2)
rand.reliab.Model2 <- do.call("rbind", rand.reliab.Model2)

models_all_unstand_Model2 <- list()
for(i in 1:length(models_all_list_Model2)){
  models_all_unstand_Model2[[i]] <- models_all_list_Model2[[i]]$parameters$unstandardized
}
for(i in 1:length(models_all_unstand_Model2)){
  models_all_unstand_Model2[[i]] <- models_all_unstand_Model2[[i]] %>% dplyr::filter(sig == TRUE)
}
models_all_unstand_Model2 <- do.call("rbind", models_all_unstand_Model2)
models_all_unstand_Model2 <- models_all_unstand_Model2 %>% dplyr::filter(paramHeader != "Variances") %>%
                                           dplyr::filter(param == "HM"|
                                                         param == "HD"|
                                                         param == "HI"|
                                                         param == "PM"|
                                                         param == "PD") %>% 
  dplyr::filter(paramHeader != "Variances")

```

## Model 3 - Parenting Stress Index, Short Form (single moderator)

```{r}
library(MplusAutomation)
# 
# runModels(
#   paste(getwd(),"DSEM","DSEM_Model3_PSI-SF",
#         "2023.02.13_TriadicAffect_Model3.1_PSI-SF_Mom.inp", sep = "/"),
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)
# 
# runModels(
#   paste(getwd(),"DSEM","DSEM_Model3_PSI-SF",
#         "2023.02.13_TriadicAffect_Model3.2_PSI-SF_Dad.inp", sep = "/"),
#   showOutput=TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)

# runModels(
#   paste(getwd(),"DSEM","DSEM_Models_3.1-3.9", sep = "/"),
#   showOutput=TRUE, recursive = TRUE,
#   replaceOutfile = "always",
#   killOnFail = FALSE,
#   quiet = FALSE)

models_all_list_Model3 <- readModels(paste(getwd(),"DSEM","DSEM_Models_3.1-3.9",sep = "/"),
                          what = "parameters",
                          recursive = TRUE)

models_all_stdyx_Model3 <- list()
for(i in 1:length(models_all_list_Model3)){
  models_all_stdyx_Model3[[i]] <- models_all_list_Model3[[i]]$parameters$stdyx.standardized
}
sapply(models_all_stdyx_Model3, ncol)
for(i in 1:length(models_all_stdyx_Model3)){
  models_all_stdyx_Model3[[i]] <- models_all_stdyx_Model3[[i]] %>% dplyr::filter(sig == TRUE)
}
models_all_stdyx_Model3 <- do.call("rbind", models_all_stdyx_Model3)
models_all_stdyx_Model3 <- models_all_stdyx_Model3 %>% dplyr::filter(param == "HM"|
                                                         param == "HD"|
                                                         param == "HI"|
                                                         param == "PM"|
                                                         param == "PD")

models_all_tech4_Model3 <- readModels(paste(getwd(),"DSEM","DSEM_Models_2.1-2.9",sep = "/"),
                          what = "tech4",
                          recursive = TRUE)

rand.reliab.Model3 <- random_eff_reliabilities(models_all_tech4_Model3)
rand.reliab.Model3 <- do.call("rbind", rand.reliab.Model3)

models_all_unstand_Model3 <- list()
for(i in 1:length(models_all_list_Model3)){
  models_all_unstand_Model3[[i]] <- models_all_list_Model3[[i]]$parameters$unstandardized
}
for(i in 1:length(models_all_unstand_Model3)){
  models_all_unstand_Model3[[i]] <- models_all_unstand_Model3[[i]] %>% dplyr::filter(sig == TRUE)
}
models_all_unstand_Model3 <- do.call("rbind", models_all_unstand_Model3)
models_all_unstand_Model3 <- models_all_unstand_Model3 %>% dplyr::filter(paramHeader != "Variances") %>%
                                           dplyr::filter(param == "HM"|
                                                         param == "HD"|
                                                         param == "HI"|
                                                         param == "PM"|
                                                         param == "PD") %>% 
  dplyr::filter(paramHeader != "Variances")

```

<!-- # Tables  -->
<!-- Model 1 -->
<!-- Create table -->
<!-- ```{r} -->
<!-- ntercreate_nice_table_baseline <- function(table_inp){ -->
<!--       #Change all strings to lower case -->
<!--       table_inp$paramHeader <- tolower(table_inp$paramHeader) -->
<!--       table_inp$param <- tolower(table_inp$param) -->

<!--       #Trim strings -->
<!--       table_inp$paramHeader <- str_remove(table_inp$paramHeader, ".on") -->

<!--       #Create a single column for the credible intervals -->
<!--       #Create a new columns that denotes "significance" -->
<!--       table_inp$CR <- NA -->
<!--       table_inp$Sig. <- NA -->
<!--       for(j in 1:nrow(table_inp)){ -->
<!--         table_inp$Sig.[j] <- ifelse((sign(table_inp$upper_2.5ci[j])==sign(table_inp$lower_2.5ci[j])),"*"," ") -->
<!--         table_inp$CR[j] <- paste("[",table_inp$lower_2.5ci[j],",",table_inp$upper_2.5ci[j],"]", sep = "") -->
<!--       } -->

<!--       #Drop unneeded columns -->
<!--       table_inp <- table_inp %>% select(-lower_2.5ci, -upper_2.5ci, -pval) -->

<!--       #Rename parameters -->
<!--       names_parTable <- c("Y", "X", "Est.", "Post.SD","sig", "BetweenWithin", "Cred.Int.", "Sig.") -->
<!--       names(table_inp) <- names_parTable -->

<!--       #Rename cells -->
<!--       table_inp$Y <- str_replace(table_inp$Y, "phi", "\U03c6") -->
<!--       table_inp$Y <- str_replace(table_inp$Y, "aff_m", "Mom Aff.") -->
<!--       table_inp$Y <- str_replace(table_inp$Y, "aff_d", "Dad Aff.") -->
<!--       table_inp$Y <- str_replace(table_inp$Y, "aff_i", "Inf. Aff.") -->

<!--       table_inp$Y <- str_remove(table_inp$Y, ".with") -->

<!--       table_inp$X <- str_replace(table_inp$X, "aff_m", "MomAff.") -->
<!--       table_inp$X <- str_replace(table_inp$X, "aff_d", "DadAff.") -->
<!--       table_inp$X <- str_replace(table_inp$X, "aff_i", "Inf.Aff.") -->

<!--       table_inp$X <- str_replace(table_inp$X, "&1", " & LAG1") -->
<!--       table_inp$X <- str_replace(table_inp$X, "MomAff. & LAG1", "MA & LAG1") -->
<!--       table_inp$X <- str_replace(table_inp$X, "DadAff. & LAG1", "DA & LAG1") -->
<!--       table_inp$X <- str_replace(table_inp$X, "Inf.Aff. & LAG1", "IA & LAG1") -->

<!--       table_inp <- table_inp[order(table_inp$Y),] -->

<!--       table_inp$Est. <- as.character(table_inp$Est.) -->
<!--       table_inp$Post.SD <- as.character(table_inp$Post.SD) -->

<!--       table_out <- table_inp  -->
<!--   return(table_out) -->
<!-- } -->


<!-- tab_Mod1_tri_std <- create_nice_table_baseline(models1_stdyx) %>% dplyr::filter(BetweenWithin == "Within.Std.Averaged.Over.Clusters") %>% dplyr::select(-BetweenWithin, -sig) -->
<!-- tab_Mod1_tri_und <- create_nice_table_baseline(models1_unstand) %>% dplyr::filter(Y== "means") %>% dplyr::select(-BetweenWithin, -sig) -->


<!-- add_gammas <- function(table_inp){ -->
<!--   parameters_symb <- c("\U03b3", "\U03b3", "\U03b3", -->
<!--                      "\U03b3", "\U03b3", "\U03b3", -->
<!--                      "\U03b3", "\U03b3", "\U03b3") -->
<!-- parameters_num <- c("10", "20", "30", -->
<!--                     "50", "60", "70", -->
<!--                     "90","100","110") -->
<!-- paste(parameters_symb, parameters_num, sep="") -->
<!-- parameters_df <- data.frame(paste(parameters_symb, parameters_num, sep="")) -->
<!-- names(parameters_df) <- c("Parameter") -->
<!-- new_names <- c(names(parameters_df), names(table_inp)) -->
<!-- table_out <- cbind(parameters_df, table_inp) -->
<!-- names(table_out) <- new_names -->
<!-- table_out <- table_out %>% select(Y,X,Parameter,Est.,Post.SD,Cred.Int.,Sig.) -->
<!-- return(table_out) -->
<!-- } -->
<!-- tab_Mod1_tri_std <- add_gammas(tab_Mod1_tri_std) -->
<!-- tab_Mod1_tri_und <- add_gammas(tab_Mod1_tri_und) -->

<!-- tab_Mod1_tri_std$Std.<- "*" -->
<!-- tab_Mod1_tri_und$Std.<- " " -->

<!-- tab_Mod1_tri_all <- rbind(tab_Mod1_tri_std, tab_Mod1_tri_und) -->

<!-- footnote.baseline <- c("Unstandardized estimates are reported above, and within-family standardized estimates averaged across clusters are reported below in accordance with suggestions by Schuurman et al. (2016). 'Est.' = Posterior median, 'Post.SD' = Posterior standard deviation, 'Cred.Int.' = 95% Credible interval derived from posterior distribution, 'Sig.' = Denotes credible intervals that do not contain zero. 'Std.' = Denotes standardized estimates. 'MA & LAG1', 'DA & LAG1', and 'IA & LAG1' refer to maternal, paternal, and infant affect, respectively, measured with a one-second lag") -->
<!-- ``` -->


<!-- ```{r, echo=FALSE} -->
<!-- # Baseline Model -->
<!-- nice_table( -->
<!--   tab_Mod1_tri_all, -->
<!--   title = c("Table 1", "Unstandardized and Standardized Estimates of Autoregressive and Cross-Lagged Effects"), -->
<!--   footnote = footnote.baseline) %>% -->
<!--   bold(~ Sig. == "*", ~ Y + X + Parameter + Est. + Post.SD + Cred.Int. + Sig. + Std., bold = TRUE)  %>% -->
<!--   bg(bg = "gray", part = "header") %>% -->
<!--   line_spacing(space = .5, part = "body", unit = "in") %>% -->
<!--   line_spacing(space = 1, part = "header", unit = "in") %>% -->
<!--   fontsize(size = 10, part = "footer") %>% -->
<!--   fontsize(size = 12, part = "body") -->
<!-- ``` -->


<!-- Models 3 - 6 -->
<!-- Create tables -->
<!-- ```{r, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE} -->
<!-- create_nice_tables <- function(table_inp){ -->
<!--       table_inp$paramHeader <- tolower(table_inp$paramHeader) -->
<!--       table_inp$param <- tolower(table_inp$param) -->

<!--       #Trim strings -->
<!--       table_inp$paramHeader <- str_remove(table_inp$paramHeader, ".on") -->

<!--       #Create a single column for the credible intervals -->
<!--       #Create a new columns that denotes "significance" -->
<!--       table_inp$CR <- NA -->
<!--       table_inp$Sig. <- NA -->
<!--       for(j in 1:nrow(table_inp)){ -->
<!--         table_inp$Sig.[j] <- ifelse((sign(table_inp$upper_2.5ci[j])==sign(table_inp$lower_2.5ci[j])),"*"," ") -->
<!--         table_inp$CR[j] <- paste("[",table_inp$lower_2.5ci[j],",",table_inp$upper_2.5ci[j],"]", sep = "") -->
<!--       } -->

<!--       #Drop unneeded columns -->
<!--       table_inp <- table_inp %>% select(-lower_2.5ci, -upper_2.5ci, -pval) -->

<!--       #Rename parameters -->
<!--       names_parTable <- c("Y", "X", "Est.", "Post.SD", "sig","BetweenWithin", "Cred.Int.", "Sig.") -->
<!--       names(table_inp) <- names_parTable -->

<!--       #Rename cells -->
<!--       table_inp$Y <- str_replace(table_inp$Y, "phi", "\U03c6") -->
<!--       table_inp$Y <- str_replace(table_inp$Y, "aff_m", "MomAff.") -->
<!--       table_inp$Y <- str_replace(table_inp$Y, "aff_d", "DadAff.") -->
<!--       table_inp$Y <- str_replace(table_inp$Y, "aff_i", "Inf.Aff.") -->
<!--       table_inp$Y <- str_remove(table_inp$Y, ".with") -->

<!--       table_inp$X <- str_replace(table_inp$X, "aff_m", "MomAff.") -->
<!--       table_inp$X <- str_replace(table_inp$X, "aff_d", "DadAff.") -->
<!--       table_inp$X <- str_replace(table_inp$X, "aff_i", "Inf.Aff.") -->

<!--       table_inp$X <- str_replace(table_inp$X, "ai", "Age") -->
<!--       table_inp$X <- str_replace(table_inp$X, "si", "Sex") -->
<!--       table_inp$X <- str_replace(table_inp$X, "bw", "Wt.") -->
<!--       table_inp$X <- str_replace(table_inp$X, "zg", "Gest.") -->

<!--       table_inp$X <- str_replace(table_inp$X, "om", "OT(Mom)") -->
<!--       table_inp$X <- str_replace(table_inp$X, "od", "OT(Dad)") -->

<!--       table_inp$X <- str_replace(table_inp$X, "hm", "HCC(Mom)") -->
<!--       table_inp$X <- str_replace(table_inp$X, "hd", "HCC(Dad)") -->
<!--       table_inp$X <- str_replace(table_inp$X, "hi", "HCC(Inf.)") -->

<!--       table_inp$X <- str_replace(table_inp$X, "dm", "PPD(Mom)") -->
<!--       table_inp$X <- str_replace(table_inp$X, "dd", "PPD(Dad)") -->

<!--       table_inp$X <- str_replace(table_inp$X, "pm", "PSI(Mom)") -->
<!--       table_inp$X <- str_replace(table_inp$X, "pd", "PSI(Dad)") -->

<!--       table_inp$Est. <- as.character(table_inp$Est.) -->
<!--       table_inp$Post.SD <- as.character(table_inp$Post.SD) -->

<!--       table_out <- table_inp %>% dplyr::select(-BetweenWithin, -sig) -->
<!--       return(table_out) -->
<!-- } -->

<!-- tab_Mod3to6_stx <- create_nice_tables(models3to6_stdyx) -->
<!-- tab_Mod3to6_und <- create_nice_tables(models3to6_unstand) -->

<!-- tab_ModAll_stx <- create_nice_tables(models_all_stdyx) -->
<!-- tab_ModAll_und <- create_nice_tables(models_all_unstand) -->

<!-- tab_ModAll_stx$Std. <- "*" -->
<!-- tab_ModAll_und$Std. <- " " -->

<!-- format_table <- function(table_inp){ -->
<!-- table_inp$Model <- c("Infant", "Mother", "Mother","Father") -->
<!-- table_inp <- table_inp %>% select(Model, Y, X, Est., Post.SD, Cred.Int., Std.) -->
<!-- } -->

<!-- tab_ModAll_stx <- format_table(tab_ModAll_stx) -->
<!-- tab_ModAll_und <- format_table(tab_ModAll_und) -->

<!-- tab_ModAll_all <- rbind(tab_ModAll_stx, tab_ModAll_und) -->

<!-- footnote.sig <- c("Only statistically significant moderation effects are reported from Models 3 - 6. Unstandardized estimates are reported above, and within-family standardized estimates averaged across clusters are reported below in accordance with suggestions by Schuurman et al. (2016). 'Est.' = Posterior median, 'Post.SD' = Posterior standard deviation, 'Cred.Int.' = 95% Credible interval derived from posterior distribution.'Std.' = Denotes standardized estimates. HCC = Hair cortisol concentration at six-months postpartum. PSI = Parenting Stress. OT = Extracted oxytocin ") -->
<!-- ``` -->

<!-- Significant effects across Models 3 - 6 -->
<!-- ```{r} -->
<!-- nice_table( -->
<!--   tab_ModAll_all, -->
<!--   title = c("Table 2", "Parent's hair cortisol, stress, and oxytocin moderate affective synchrony"), -->
<!--   footnote = footnote.sig) %>% -->
<!--   bg(bg = "gray", part = "header") %>% -->
<!--   line_spacing(space = .5, part = "body", unit = "in") %>% -->
<!--   line_spacing(space = 1, part = "header", unit = "in") %>% -->
<!--   fontsize(size = 10, part = "footer") %>% -->
<!--   fontsize(size = 12, part = "body") -->
<!-- ``` -->

<!-- Moderation effects for Model 3 (sig and non-sig) -->
<!-- ```{r} -->

<!-- models3_stdyx_all <- list() -->
<!-- for(i in 1:length(models_all_list)){ -->
<!--   models3_stdyx_all[[i]] <- models_all_list[[i]]$parameters$stdyx.standardized -->
<!-- } -->
<!-- models3_stdyx_all <- do.call("rbind", models3_stdyx_all) -->
<!-- models3_stdyx_all <- models3_stdyx_all %>% dplyr::filter(param == "HM"| -->
<!--                                                      param == "HD") %>% -->
<!--   dplyr::filter(paramHeader != "Variances") %>% -->
<!--   dplyr::filter(paramHeader != "Means") -->
<!-- models3_stdyx_all <- models3_stdyx_all[order(models3_stdyx_all$param,models3_stdyx_all$paramHeader),] -->

<!-- tab_Mod3_stdyx <- create_nice_tables(models3_stdyx_all) -->

<!-- footnote.mod3 <- c("Within-family standardized estimates averaged across clusters are reported below in accordance with suggestions by Schuurman et al. (2016). 'Est.' = Posterior median, 'Post.SD' = Posterior standard deviation, 'Cred.Int.' = 95% Credible interval derived from posterior distribution.'Std.' = Denotes standardized estimates. HCC = Hair cortisol concentration at six-months postpartum. PSI = Parenting Stress. OT = Extracted oxytocin ") -->

<!-- nice_table( -->
<!--   tab_Mod3_stdyx, -->
<!--   title = c("Table 3", "Parent's hair cortisol moderates affective synchrony"), -->
<!--   footnote = footnote.mod3) %>% -->
<!--   bg(bg = "gray", part = "header") %>% -->
<!--   line_spacing(space = .5, part = "body", unit = "in") %>% -->
<!--   line_spacing(space = 1, part = "header", unit = "in") %>% -->
<!--   fontsize(size = 10, part = "footer") %>% -->
<!--   fontsize(size = 12, part = "body") -->
<!-- ``` -->


<!-- Moderation effects for Model 4 (sig and non-sig) -->
<!-- ```{r} -->

<!-- models4_stdyx_all <- list() -->
<!-- for(i in 1:length(models_all_list)){ -->
<!--   models4_stdyx_all[[i]] <- models_all_list[[i]]$parameters$stdyx.standardized -->
<!-- } -->
<!-- models4_stdyx_all <- do.call("rbind", models4_stdyx_all) -->
<!-- models4_stdyx_all <- models4_stdyx_all %>% dplyr::filter(param == "PM"| -->
<!--                                                      param == "PD") %>% -->
<!--   dplyr::filter(paramHeader != "Variances") %>% -->
<!--   dplyr::filter(paramHeader != "Means") -->
<!-- models4_stdyx_all <- models4_stdyx_all[order(models4_stdyx_all$param,models4_stdyx_all$paramHeader),] -->

<!-- tab_Mod4_stdyx <- create_nice_tables(models4_stdyx_all) -->

<!-- footnote.Mod4 <- c("Within-family standardized estimates averaged across clusters are reported below in accordance with suggestions by Schuurman et al. (2016). 'Est.' = Posterior median, 'Post.SD' = Posterior standard deviation, 'Cred.Int.' = 95% Credible interval derived from posterior distribution.'Std.' = Denotes standardized estimates. HCC = Hair cortisol concentration at six-months postpartum. PSI = Parenting Stress. OT = Extracted oxytocin ") -->

<!-- nice_table( -->
<!--   tab_Mod4_stdyx, -->
<!--   title = c("Table 4", "Parent's hair cortisol moderates affective synchrony"), -->
<!--   footnote = footnote.Mod4) %>% -->
<!--   bg(bg = "gray", part = "header") %>% -->
<!--   line_spacing(space = .5, part = "body", unit = "in") %>% -->
<!--   line_spacing(space = 1, part = "header", unit = "in") %>% -->
<!--   fontsize(size = 10, part = "footer") %>% -->
<!--   fontsize(size = 12, part = "body") -->
<!-- ``` -->

# Equations

## Model 1 - Mother's equation
$$
\begin{aligned}
  \text{WITHIN MODEL - MOTHER} & \\
  \text{Mom}_{w,tj}    & =  \phi_{1j} \text{Mom}_{w,(t-1)j} + \phi_{2j} \text{Dad}_{w,(t-1)j} + \phi_{3j} \text{Infant}_{w,(t-1)j} + e_{1tj}  \\
  \text{Dad}_{w,tj}    & =  \phi_{4j} \text{Dad}_{w,(t-1)j}  + e_{2tj}  \\
  \text{Infant}_{w,tj}    & =  \phi_{7j} \text{Infant}_{w,(t-1)j}  + e_{3tj}  \\
  \left[\begin{array}
  {rrr}
  e_{1tj}\\
  e_{2tj}\\
  e_{3tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \sigma_{1}^2 & & \\
   \sigma_{21}^2 & \sigma_{2}^2 & \\
   \sigma_{31}^2 & \sigma_{32}^2 & \sigma_{3}^2 \\
   \end{array}\right]
  \end{pmatrix} \\
  \text{BETWEEN MODEL - MOTHER} & \\
  \text{Mom}_{b,j} & = \gamma_{00} + \mu_{0j}\\
  \text{Dad}_{b,j} & = \gamma_{10} + \mu_{1j}\\
  \text{Infant}_{b,j} & = \gamma_{20} + \mu_{2j}\\
  \phi_{1j} & = \gamma_{30}  + \mu_{3j}\\
  \phi_{2j} & = \gamma_{40}   + \mu_{4j}\\
  \phi_{3j} & = \gamma_{50}   + \mu_{5j}\\
  \phi_{4j} & = \gamma_{60}   + \mu_{6j}\\
  \phi_{7j} & = \gamma_{70}   + \mu_{7j}\\
  \left[\begin{array}
  {rrr}
  \mu_{0tj}\\
  \mu_{1tj}\\
  \mu_{2tj}\\
  \mu_{3tj}\\
  \mu_{4tj}\\
  \mu_{5tj}\\
  \mu_{6tj}\\
  \mu_{7tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \tau_{00}^2 & & & & & & & \\
   \tau_{01}^2 & \tau_{11}^2 & & & & & & \\
   \tau_{02}^2 & \tau_{21}^2 & \tau_{22}^2 & & & & & \\
   \tau_{03}^2 & \tau_{31}^2 & \tau_{32}^2 & \tau_{33}^2 & & & & \\
   \tau_{04}^2 & \tau_{41}^2 & \tau_{42}^2 & \tau_{43}^2 & \tau_{44}^2 & & & \\
   \tau_{05}^2 & \tau_{51}^2 & \tau_{52}^2 & \tau_{53}^2 & \tau_{54}^2 & \tau_{55}^2 & & \\
   \tau_{06}^2 & \tau_{61}^2 & \tau_{62}^2 & \tau_{63}^2 & \tau_{64}^2 & \tau_{65}^2 & \tau_{66}^2 & \\
   \tau_{07}^2 & \tau_{71}^2 & \tau_{72}^2 & \tau_{73}^2 & \tau_{74}^2 & \tau_{75}^2 & \tau_{76}^2 & \tau_{77}^2 \\
  \end{array}\right]
  \end{pmatrix}\\
\end{aligned}
$$

## Model 1 - Father's equation 

$$
\begin{aligned}
  \text{WITHIN MODEL - FATHER} & \\
  \text{Dad}_{w,tj}    & =  \phi_{4j} \text{Dad}_{w,(t-1)j} + \phi_{5j} \text{Mom}_{w,(t-1)j} + \phi_{6j} \text{Infant}_{w,(t-1)j} + e_{1tj}  \\
  \text{Mom}_{w,tj}    & =  \phi_{1j} \text{Mom}_{w,(t-1)j}  + e_{2tj}  \\
  \text{Infant}_{w,tj}    & =  \phi_{7j} \text{Infant}_{w,(t-1)j}  + e_{3tj}  \\
  \left[\begin{array}
  {rrr}
  e_{1tj}\\
  e_{2tj}\\
  e_{3tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \sigma_{1}^2 & & \\
   \sigma_{21}^2 & \sigma_{2}^2 & \\
   \sigma_{31}^2 & \sigma_{32}^2 & \sigma_{3}^2 \\
   \end{array}\right]
  \end{pmatrix} \\
  \text{BETWEEN MODEL - FATHER} & \\
  \text{Dad}_{b,j} & = \gamma_{00} + \mu_{0j}\\
  \text{Mom}_{b,j} & = \gamma_{10} + \mu_{1j}\\
  \text{Infant}_{b,j} & = \gamma_{20} + \mu_{2j}\\
  \phi_{4j} & = \gamma_{30}  + \mu_{3j}\\
  \phi_{5j} & = \gamma_{40}   + \mu_{4j}\\
  \phi_{6j} & = \gamma_{50}   + \mu_{5j}\\
  \phi_{1j} & = \gamma_{60}   + \mu_{6j}\\
  \phi_{7j} & = \gamma_{70}   + \mu_{7j}\\
  \left[\begin{array}
  {rrr}
  \mu_{0tj}\\
  \mu_{1tj}\\
  \mu_{2tj}\\
  \mu_{3tj}\\
  \mu_{4tj}\\
  \mu_{5tj}\\
  \mu_{6tj}\\
  \mu_{7tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \tau_{00}^2 & & & & & & & \\
   \tau_{01}^2 & \tau_{11}^2 & & & & & & \\
   \tau_{02}^2 & \tau_{21}^2 & \tau_{22}^2 & & & & & \\
   \tau_{03}^2 & \tau_{31}^2 & \tau_{32}^2 & \tau_{33}^2 & & & & \\
   \tau_{04}^2 & \tau_{41}^2 & \tau_{42}^2 & \tau_{43}^2 & \tau_{44}^2 & & & \\
   \tau_{05}^2 & \tau_{51}^2 & \tau_{52}^2 & \tau_{53}^2 & \tau_{54}^2 & \tau_{55}^2 & & \\
   \tau_{06}^2 & \tau_{61}^2 & \tau_{62}^2 & \tau_{63}^2 & \tau_{64}^2 & \tau_{65}^2 & \tau_{66}^2 & \\
   \tau_{07}^2 & \tau_{71}^2 & \tau_{72}^2 & \tau_{73}^2 & \tau_{74}^2 & \tau_{75}^2 & \tau_{76}^2 & \tau_{77}^2 \\
  \end{array}\right]
  \end{pmatrix}\\
\end{aligned}
$$

## Model 1 - Infant's Equation

$$
\begin{aligned}
  \text{WITHIN MODEL - INFANT} & \\
  \text{Infant}_{w,tj}    & =   \phi_{7j} \text{Infant}_{w,(t-1)j} + \phi_{8j} \text{Mom}_{w,(t-1)j} + \phi_{9j} \text{Dad}_{w,(t-1)j} + e_{1tj}  \\
  \text{Mom}_{w,tj}    & =   \phi_{1j} \text{Mom}_{w,(t-1)j}  + e_{2tj}  \\
  \text{Dad}_{w,tj}    & =   \phi_{4j} \text{Dad}_{w,(t-1)j}  + e_{3tj}  \\
  \left[\begin{array}
  {rrr}
  e_{1tj}\\
  e_{2tj}\\
  e_{3tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \sigma_{1}^2 & & \\
   \sigma_{21}^2 & \sigma_{2}^2 & \\
   \sigma_{31}^2 & \sigma_{32}^2 & \sigma_{3}^2 \\
   \end{array}\right]
  \end{pmatrix} \\
  \text{BETWEEN MODEL - INFANT} & \\
  \text{Infant}_{b,j} & = \gamma_{00} + \mu_{0j}\\
  \text{Mom}_{b,j} & = \gamma_{10} + \mu_{1j}\\
  \text{Dad}_{b,j} & = \gamma_{20} + \mu_{2j}\\
  \phi_{7j} & = \gamma_{30}  + \mu_{3j}\\
  \phi_{8j} & = \gamma_{40}   + \mu_{4j}\\
  \phi_{9j} & = \gamma_{50}   + \mu_{5j}\\
  \phi_{1j} & = \gamma_{60}   + \mu_{6j}\\
  \phi_{4j} & = \gamma_{70}   + \mu_{7j}\\
  \left[\begin{array}
  {rrr}
  \mu_{0tj}\\
  \mu_{1tj}\\
  \mu_{2tj}\\
  \mu_{3tj}\\
  \mu_{4tj}\\
  \mu_{5tj}\\
  \mu_{6tj}\\
  \mu_{7tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \tau_{00}^2 & & & & & & & \\
   \tau_{01}^2 & \tau_{11}^2 & & & & & & \\
   \tau_{02}^2 & \tau_{21}^2 & \tau_{22}^2 & & & & & \\
   \tau_{03}^2 & \tau_{31}^2 & \tau_{32}^2 & \tau_{33}^2 & & & & \\
   \tau_{04}^2 & \tau_{41}^2 & \tau_{42}^2 & \tau_{43}^2 & \tau_{44}^2 & & & \\
   \tau_{05}^2 & \tau_{51}^2 & \tau_{52}^2 & \tau_{53}^2 & \tau_{54}^2 & \tau_{55}^2 & & \\
   \tau_{06}^2 & \tau_{61}^2 & \tau_{62}^2 & \tau_{63}^2 & \tau_{64}^2 & \tau_{65}^2 & \tau_{66}^2 & \\
   \tau_{07}^2 & \tau_{71}^2 & \tau_{72}^2 & \tau_{73}^2 & \tau_{74}^2 & \tau_{75}^2 & \tau_{76}^2 & \tau_{77}^2 \\
  \end{array}\right]
  \end{pmatrix}\\
\end{aligned}
$$

## Model 2 - Mother's Equation (HCC)

$$
\begin{aligned}
  \text{WITHIN MODEL - MOTHER} & \\
  \text{Mom}_{w,tj}    & =   \phi_{1j} \text{Mom}_{w,(t-1)j} + \phi_{2j} \text{Dad}_{w,(t-1)j} + \phi_{3j} \text{Infant}_{w,(t-1)j} + e_{1tj}  \\
  \text{Dad}_{w,tj}    & =  \phi_{4j} \text{Dad}_{w,(t-1)j}  + e_{2tj}  \\
  \text{Infant}_{w,tj}    & =   \phi_{7j} \text{Infant}_{w,(t-1)j}  + e_{3tj}  \\
  \left[\begin{array}
  {rrr}
  e_{1tj}\\
  e_{2tj}\\
  e_{3tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \sigma_{1}^2 & & \\
   \sigma_{21}^2 & \sigma_{2}^2 & \\
   \sigma_{31}^2 & \sigma_{32}^2 & \sigma_{3}^2 \\
   \end{array}\right]
  \end{pmatrix} \\
  \text{BETWEEN MODEL - MOTHER} & \\
  \text{Mom}_{b,j} & =       \gamma_{00} + \gamma_{01} \text{Mother's HCC}_{j} + \mu_{0j}\\
  \text{Dad}_{b,j} & =       \gamma_{10} +  \mu_{1j}\\
  \text{Infant}_{b,j} & =    \gamma_{20} +  \mu_{2j}\\
  \phi_{1j} & = \gamma_{30}  +\gamma_{31} \text{Mother's HCC}_{j} + \mu_{3j}\\
  \phi_{2j} & = \gamma_{40}  +\gamma_{41} \text{Mother's HCC}_{j} + \mu_{4j}\\
  \phi_{3j} & = \gamma_{50}  +\gamma_{51} \text{Mother's HCC}_{j} + \mu_{5j}\\
  \phi_{4j} & = \gamma_{60}  + \mu_{6j}\\
  \phi_{7j} & = \gamma_{70}  + \mu_{7j}\\
  \left[\begin{array}
  {rrr}
  \mu_{0tj}\\
  \mu_{1tj}\\
  \mu_{2tj}\\
  \mu_{3tj}\\
  \mu_{4tj}\\
  \mu_{5tj}\\
  \mu_{6tj}\\
  \mu_{7tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \tau_{00}^2 & & & & & & & \\
   \tau_{01}^2 & \tau_{11}^2 & & & & & & \\
   \tau_{02}^2 & \tau_{21}^2 & \tau_{22}^2 & & & & & \\
   \tau_{03}^2 & \tau_{31}^2 & \tau_{32}^2 & \tau_{33}^2 & & & & \\
   \tau_{04}^2 & \tau_{41}^2 & \tau_{42}^2 & \tau_{43}^2 & \tau_{44}^2 & & & \\
   \tau_{05}^2 & \tau_{51}^2 & \tau_{52}^2 & \tau_{53}^2 & \tau_{54}^2 & \tau_{55}^2 & & \\
   \tau_{06}^2 & \tau_{61}^2 & \tau_{62}^2 & \tau_{63}^2 & \tau_{64}^2 & \tau_{65}^2 & \tau_{66}^2 & \\
   \tau_{07}^2 & \tau_{71}^2 & \tau_{72}^2 & \tau_{73}^2 & \tau_{74}^2 & \tau_{75}^2 & \tau_{76}^2 & \tau_{77}^2 \\
  \end{array}\right]
  \end{pmatrix}\\
\end{aligned}
$$



## Model 3 - Mother's Equation (PSI)

$$
\begin{aligned}
  \text{WITHIN MODEL 3.1 - MOTHER} & \\
  \text{Mom}_{w,tj}    & =   \phi_{1j} \text{Mom}_{w,(t-1)j} + \phi_{2j} \text{Dad}_{w,(t-1)j} + \phi_{3j} \text{Infant}_{w,(t-1)j} + e_{1tj}  \\
  \text{Dad}_{w,tj}    & =  \phi_{4j} \text{Dad}_{w,(t-1)j}  + e_{2tj}  \\
  \text{Infant}_{w,tj}    & =   \phi_{7j} \text{Infant}_{w,(t-1)j}  + e_{3tj}  \\
  \left[\begin{array}
  {rrr}
  e_{1tj}\\
  e_{2tj}\\
  e_{3tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \sigma_{1}^2 & & \\
   \sigma_{21}^2 & \sigma_{2}^2 & \\
   \sigma_{31}^2 & \sigma_{32}^2 & \sigma_{3}^2 \\
   \end{array}\right]
  \end{pmatrix} \\
  \text{BETWEEN MODEL 3.1 - MOTHER} & \\
  \text{Mom}_{b,j} & =       \gamma_{00} + \gamma_{01} \text{Mother's PSI}_{j} + \mu_{0j}\\
  \text{Dad}_{b,j} & =       \gamma_{10} +  \mu_{1j}\\
  \text{Infant}_{b,j} & =    \gamma_{20} +  \mu_{2j}\\
  \phi_{1j} & = \gamma_{30}  +\gamma_{31} \text{Mother's PSI}_{j} + \mu_{3j}\\
  \phi_{2j} & = \gamma_{40}  +\gamma_{41} \text{Mother's PSI}_{j} + \mu_{4j}\\
  \phi_{3j} & = \gamma_{50}  +\gamma_{51} \text{Mother's PSI}_{j} + \mu_{5j}\\
  \phi_{4j} & = \gamma_{60}  + \mu_{6j}\\
  \phi_{7j} & = \gamma_{70}  + \mu_{7j}\\
  \left[\begin{array}
  {rrr}
  \mu_{0tj}\\
  \mu_{1tj}\\
  \mu_{2tj}\\
  \mu_{3tj}\\
  \mu_{4tj}\\
  \mu_{5tj}\\
  \mu_{6tj}\\
  \mu_{7tj}\\
  \end{array}\right] & \sim \mathcal{N}
  \begin{pmatrix}
  \left[\begin{array}
  {rrr}
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  0\\
  \end{array}\right],
  \left[\begin{array}
  {rrr}
   \tau_{00}^2 & & & & & & & \\
   \tau_{01}^2 & \tau_{11}^2 & & & & & & \\
   \tau_{02}^2 & \tau_{21}^2 & \tau_{22}^2 & & & & & \\
   \tau_{03}^2 & \tau_{31}^2 & \tau_{32}^2 & \tau_{33}^2 & & & & \\
   \tau_{04}^2 & \tau_{41}^2 & \tau_{42}^2 & \tau_{43}^2 & \tau_{44}^2 & & & \\
   \tau_{05}^2 & \tau_{51}^2 & \tau_{52}^2 & \tau_{53}^2 & \tau_{54}^2 & \tau_{55}^2 & & \\
   \tau_{06}^2 & \tau_{61}^2 & \tau_{62}^2 & \tau_{63}^2 & \tau_{64}^2 & \tau_{65}^2 & \tau_{66}^2 & \\
   \tau_{07}^2 & \tau_{71}^2 & \tau_{72}^2 & \tau_{73}^2 & \tau_{74}^2 & \tau_{75}^2 & \tau_{76}^2 & \tau_{77}^2 \\
  \end{array}\right]
  \end{pmatrix}\\
\end{aligned}
$$